## 基本原理
骨骼动画是一种计算机动画技术，它将三维模型分为两部分：用于绘制模型的蒙皮（Mesh），以及用于控制动作的骨架（skeleton）。跟传统逐格动画相异，骨骼动画利用建立好的骨架套用到一张或多张图片，使之动作，比起一般一张一张绘出动作省了很多时间与精力，且能更生动的动作。3D美术人员制作一个带骨骼动画的模型时，主要要分2个步骤，一是建模（可能包括画贴图），二是给模型加上骨骼并制作骨骼动画。

#### 关节

用于设置骨骼网格动画的骨架由多个关节组成。每个接头具有由位置和旋转组成的变换，并且可以有父关节其变换是关于。在游戏中，角色的脸也可能由关节组成——嘴巴的两侧可能是可以通过动画移动的关节，使嘴唇在说话时移动。关节也可以用作“附着”点-例如游戏中持有武器的角色可能会这样做，因为武器网格已经连接在角色的手中。

#### 骨架
骨架是驱动模型运动的根本，骨架由一系列具有层次关系的关节（骨骼）和关节链组成，是一种树结构，选择其中一个是根关节，其它关节是根关节的子孙，可以通过平移和旋转根关节移动并确定整个骨架在世界空间中的位置和方向。父关节运动能影响子关节运动，但子关节运动对父关节不产生影响，因此，平移或旋转父关节时，也会同时平移或旋转其所有子关节。骨架涉及的数据包括两个：
*  一是骨架的拓扑结构（连接、父子关系）
*  二是骨架的各种pose，也就是每个动作对应的整个骨架的位置信息。

给一个模型加上骨骼前，一般要求这个模型摆成T字型，才方便动作师加骨骼和做动作。此时，给模型加骨骼，让模型跟着骨骼一起运动了，这个骨肉融合的过程被称为**骨骼绑定(Skeleton Binding)**；或者从模型角度讲叫做，模型蒙皮(Model Skinning)到骨骼。这个**初始骨骼摆位，就是绑定姿势(Bind Poses)**。但要注意，Bind Poses本身只记录了骨骼各个关节的姿势信息，并不包括蒙皮信息。

在完成建模后，在进行骨骼绑定的时候，通常美术会选择模型的盆骨做为模型的根骨骼。那么基于根骨骼，可以递推出各个骨骼相对于根骨的父子关系。

<div align = "center"><img src="http://cc.fp.ps.netease.com/file/606fc1075e60278434ff9d55bpaUKIgm03"></div>

其拓扑结构类似：
<div align = "center"><img src="http://cc.fp.ps.netease.com/file/606fc3ae143cfa1a22d18a82gicPN92s03"></div>

基于根骨骼，我们可以递推出各个骨骼相对于根骨骼的父子转换矩阵，通常这样的矩阵转换为旋转矩阵，不存在平移和缩放，当然比如你的一个模型动画是拉长模型的身体，那么你可以添加平移和缩放到变换矩阵中。如下计算骨骼的全局变换矩阵：


boneGlobalTransMatrix = boneRelativeParentTransMatrix * parentGlobalTransMatrix

其中boneGlobalTransMatrix是骨骼的全局矩阵，parentGlobalTransMatrix是父骨骼的全局矩阵，而boneRelativeParentTransMatrix则是相对于父骨骼的变换矩阵；其中根骨骼是相对于场景的，那么计算根骨骼则是以scene_root作为parent来计算的，通过上面的计算则能计算出每个骨骼的全局变换矩阵。


#### 蒙皮
蒙皮则表达的是依附在骨骼上的顶点的信息，骨骼绑定的过程就是确定每个顶点受哪几根骨骼的影响，每根骨骼影响的权重有多大，譬如肘部的皮肤可能同时受大臂和小臂两根骨头的影响，而远离手肘的部分可能就只受小臂骨头影响。一般在3D骨骼动画里，每个顶点最多支持4-8根骨骼同时影响它就已经可以很精确地表达整个蒙皮的效果了，动画播放时，顶点随着关节运动，顶点的最终变换就等于它所绑定的骨架变换的加权和。对于每个顶点，我们需要有以下信息
*  该顶点绑定到的骨骼索引
*  该顶点的每个绑定骨骼的权重，他表示了骨架对顶点的影响力。

```c++
struct Vertex {
	vec3 position;
	vec3 normal;
	vec2 texCoords;
	uvec4 boneIds = glm::uvec4(0);
	vec4 boneWeights = glm::vec4(-3.0f);
};
```
计算骨骼影响到的网格顶点，需要将骨骼空间变换到网格空间

boneMeshTransMatrix = boneGlobalTransMatrix * offsetMatrix

其中boneMeshTransMatrix就是骨骼对应到网格空间后的矩阵，offsetMatrix则是在绑定姿势中从骨骼空间变换到网格空间的矩阵，也被称为反向绑定姿势矩阵。



#### 权重
顶点的最终位置都受许多骨骼关节点的影响。每个关节点对最终结果的影响有多大顶点位置由其权重决定。每个顶点对于每个参考点都有一个权重值，加起来等于1.0。然后使用这些权重值缩放由关节变换矩阵确定的顶点位置。顶点位置的变换可以通过矩阵变换描述：

Vfinal = Vmesh * boneMeshTransMatrix1 * W1 +...+ Vmesh * boneMeshTransMatrixn * Wn

其中Vmesh表示网格顶点位置，boneMeshTransMatrix表示骨骼的变换矩阵，w表示权重，顶点的最终位置就是多个 骨骼权重值 X 骨骼变换矩阵 X 顶点 位置的累加

#### 插值计算
模型在每个关键帧中都是一个固定的姿势，相当于一个“快照”，通过在不同的关键帧中进行插值平滑计算，可以得到一个较为流畅的动画表现。关键帧动画的一个优势是只需要做插值计算，相对于其他的动画计算量很小。如下分别是关键帧动画和插值计算后的动画效果：

<div align = "center"><img src="http://cc.fp.ps.netease.com/file/606fdde16f049418d9fceff7VT9Mv6gp03"></div>
<div align = "center"><img src="http://cc.fp.ps.netease.com/file/606fde3b6f04943ea8d8049dKT8bmawf03"></div>

插值计算实际上就是在两个关键帧的之间的时间范围内动态混合计算出骨骼的变换位置。

<div align = "center"><img src="http://cc.fp.ps.netease.com/file/606fdeda7f9d2a2ffabaa51d4hfJJYEC03"></div>

位置插值计算：translation = mix(keyframe1Position, keyframe2Position, scaleFactor)

旋转插值计算：rotation = slerp(keyframe1Rotation, keyframe2Rotation, scaleFactor)

缩放插值计算：scale = mix(keyframe1Scale, keyframe2Scale, scaleFactor)

其中mix是混合插值计算方法，我们使用slerp是球面线性插值方法，想要获得骨骼插值后的变换矩阵则是:

boneTransMatrix = translation * rotation * scale;

此矩阵也是相对于父骨骼的，因此想要获得全局位置的矩阵还需要乘以父矩阵：

boneGlobalTransMatrix = boneTransMatrix * parentGlobalTransMatrix


##
##
##
##

## 应用 
骨骼动画的应用面很多，主要用在3D角色动画，不过现在也很多人用于2D动画。

#### VS帧动画
跟帧动画比较来说，帧动画的每一帧都是角色特定姿势的一个快照，动画的流畅性和平滑效果都取决于帧数的多少。而骨骼动画则是把角色的各部分身体部件图片绑定到一根根互相作用连接的“骨头”上，通过控制这些骨骼的位置、旋转方向和放大缩小而生成的动画。
骨骼动画比传统的逐帧动画要求更高的处理器性能，但同时它也具有更多的优势：
* 动画更加生动逼真
* 图片资源占最小的存储空旷，
* 动画切换自动补间，过渡动画自动生成，让动作更加灵动
* 骨骼可控 ：可以通过代码控制骨骼轻松实现角色装备更换，甚至可对某骨骼做特殊控制或事件监听
* 骨骼事件帧动画执行到某个动作或某个帧，触发自定义事件行为
* 动作数据继承多角色可共用一套动画数据
* 可结合物理引擎和碰撞检测


#### 常见设计开发工具
美术设计工具常见的有3dmax、maya、blender等，这些都有常用的骨骼编辑工具插件，支持的导出模型类型有.fbx、.dae、.obj等常见格式，主要用于游戏、工业建模等，上面这些工具也是常用的游戏及工业建模的常用软件；2d的有adobe flash/adobe animate cc等。

程序开发工具常见的有unity3d、ue4等，这些工具都集成了骨骼的编辑、绑定、动画等功能，对于模型的操作都非常方便，2d的骨骼动画工具有spine和cocos，上面这些目前都是主流的游戏开发集成工具


#### 常见动捕格式
BVH文件包含角色的骨骼和肢体关节旋转数据。BVH是一种通用的人体特征动画文件格式,，广泛地被当今流行的各种动画制作软件支持。通常可从记录人类行为运动的运动捕获硬件获得。这种文件以节点为核心元素，记录连续数帧内人体骨架的运动。

FBX、DAE、OBJ等也是目前主流的三维模型软件的通用的3d文件格式，文件可以存储顶点、材质、骨骼、动画等数据，也可以只存储动画数据，不包含蒙皮信息。

#### 游戏中应用
以unity3d为例，骨骼动画主要分为骨骼变换和蒙皮计算，在实际的游戏引擎中，这些都是分开处理的，较为通用的处理是将骨骼的动画数据驱动放在CPU中，计算出骨骼的变换矩阵，然后传递给GPU中进行蒙皮计算。骨骼数量大小一般会限制在30根骨骼的大小上。将这些骨骼的变换矩阵在CPU进行计算后，就可以封装成skin info传递到GPU中。

在GPU的计算中，就会取出这些mesh上的顶点进行对应的位置计算，基于骨骼的转换矩阵和骨骼的权重，得到最新的位置，从而进行一次顶点计算和描绘。之所以将骨骼动画的两个部分分开处理，一个原因就是CPU的处理能力相对而言没有GPU快捷，一般一个模型的骨骼数量是较小的，但是mesh上的顶点数量较大，利用GPU的并行处理能力优势，可以分担CPU的计算压力。